trigger:
- '*'

variables:
  buildConfiguration: 'Release'

stages:
  - stage: 'Build'
    displayName: 'Build the web application'
    jobs: 
    - job: 'Build'
      displayName: 'Build job'
      pool:
        vmImage: 'ubuntu-18.04'

      variables:
        wwwrootDir: 'Tailspin.SpaceGame.Web/wwwroot'
        dotnetSdkVersion: '3.1.300'

      steps:
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: 'Create .Net Core App'
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: 'mossad-connection'
            subscriptionId: '31913d88-00fe-439b-9bab-a0fc309af11f'
            action: 'Create Or Update Resource Group'
            resourceGroupName: 'testpipe'
            location: 'East US'
            templateLocation: 'Linked artifact'
            csmFile: 'dotnetapp.json'
            overrideParameters: '-secretName $(secretName) -secretValue $(secretValue)'
            deploymentMode: 'Incremental'

        - task: UseDotNet@2
          displayName: 'Use .Net Core SDK $(dotnetSdkVersion)'
          inputs:
            packageType: sdk
            version: '$(dotnetSdkVersion)'

        - task: DotNetCoreCLI@2
          displayName: 'Restore project dependencies'
          inputs:
            command: 'restore'
            projects: '**/*.csproj'

        - task: DotNetCoreCLI@2
          displayName: 'Build the project - ${{ parameters.buildConfiguration }}'
          inputs:
            command: 'build'
            arguments: '--no-restore --configuration ${{ parameters.buildConfiguration }}'
            projects: '**/*.csproj'
      
        - task: DotNetCoreCLI@2
          displayName: 'Publish the project - ${{ parameters.buildConfiguration }}'
          inputs:
            command: 'publish'
            projects: '**/*.csproj'
            publishWebProjects: false
            arguments: '--no-build --configuration ${{ parameters.buildConfiguration }} --output $(Build.ArtifactStagingDirectory)/${{ parameters.buildConfiguration }}'
            zipAfterPublish: true   

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact: drop'
          condition: succeeded()
